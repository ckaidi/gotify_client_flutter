name: Release

on:
  push:
    tags:
      - 'v*.*.*'
  workflow_dispatch:
    inputs:
      version:
        description: 'Release version (e.g., v1.0.0)'
        required: true
        type: string

env:
  FLUTTER_VERSION: '3.24.0'

jobs:
  create-release:
    name: Create Release
    runs-on: ubuntu-latest
    outputs:
      upload_url: ${{ steps.create_release.outputs.upload_url }}
      release_id: ${{ steps.create_release.outputs.id }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Get version
        id: get_version
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            echo "VERSION=${{ github.event.inputs.version }}" >> $GITHUB_OUTPUT
          else
            echo "VERSION=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT
          fi

      - name: Create Release
        id: create_release
        uses: actions/create-release@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: ${{ steps.get_version.outputs.VERSION }}
          release_name: Gotify Client ${{ steps.get_version.outputs.VERSION }}
          body: |
            ## ğŸš€ Gotify Client ${{ steps.get_version.outputs.VERSION }}
            
            ### ğŸ“± æ”¯æŒå¹³å°
            - Android (APK & AAB)
            - iOS (IPA)
            - Windows (ZIP)
            - macOS (ZIP)
            - Linux (TAR.GZ)
            - Web
            
            ### ğŸ“¥ ä¸‹è½½è¯´æ˜
            - **Androidç”¨æˆ·**: ä¸‹è½½ `app-release.apk` æ–‡ä»¶
            - **Windowsç”¨æˆ·**: ä¸‹è½½ `gotify-client-windows.zip` å¹¶è§£å‹è¿è¡Œ
            - **macOSç”¨æˆ·**: ä¸‹è½½ `gotify-client-macos.zip` å¹¶è§£å‹è¿è¡Œ
            - **Linuxç”¨æˆ·**: ä¸‹è½½ `gotify-client-linux.tar.gz` å¹¶è§£å‹è¿è¡Œ
            
            ### ğŸ”§ å®‰è£…è¦æ±‚
            - Android: Android 5.0+ (API 21+)
            - iOS: iOS 12.0+
            - Windows: Windows 10+
            - macOS: macOS 10.14+
            - Linux: Ubuntu 18.04+ æˆ–å…¶ä»–ç°ä»£Linuxå‘è¡Œç‰ˆ
          draft: false
          prerelease: false

  build-android:
    name: Build Android
    runs-on: ubuntu-latest
    needs: create-release
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: 'zulu'
          java-version: '17'

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}
          channel: 'stable'

      - name: Get dependencies
        run: flutter pub get

      - name: Run code generation
        run: flutter packages pub run build_runner build --delete-conflicting-outputs

      - name: Build APK
        run: flutter build apk --release

      - name: Build App Bundle
        run: flutter build appbundle --release

      - name: Upload APK to Release
        uses: actions/upload-release-asset@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          upload_url: ${{ needs.create-release.outputs.upload_url }}
          asset_path: build/app/outputs/flutter-apk/app-release.apk
          asset_name: gotify-client-android.apk
          asset_content_type: application/vnd.android.package-archive

      - name: Upload AAB to Release
        uses: actions/upload-release-asset@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          upload_url: ${{ needs.create-release.outputs.upload_url }}
          asset_path: build/app/outputs/bundle/release/app-release.aab
          asset_name: gotify-client-android.aab
          asset_content_type: application/octet-stream

  build-ios:
    name: Build iOS
    runs-on: macos-latest
    needs: create-release
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}
          channel: 'stable'

      - name: Get dependencies
        run: flutter pub get

      - name: Run code generation
        run: flutter packages pub run build_runner build --delete-conflicting-outputs

      - name: Build iOS
        run: flutter build ios --release --no-codesign

      - name: Create IPA
        run: |
          mkdir -p build/ios/ipa
          cd build/ios/iphoneos
          zip -r ../ipa/gotify-client-ios.ipa Runner.app

      - name: Upload IPA to Release
        uses: actions/upload-release-asset@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          upload_url: ${{ needs.create-release.outputs.upload_url }}
          asset_path: build/ios/ipa/gotify-client-ios.ipa
          asset_name: gotify-client-ios.ipa
          asset_content_type: application/octet-stream

  build-windows:
    name: Build Windows
    runs-on: windows-latest
    needs: create-release
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}
          channel: 'stable'

      - name: Get dependencies
        run: flutter pub get

      - name: Run code generation
        run: flutter packages pub run build_runner build --delete-conflicting-outputs

      - name: Build Windows
        run: flutter build windows --release

      - name: Create Windows ZIP
        run: |
          Compress-Archive -Path build/windows/x64/runner/Release/* -DestinationPath gotify-client-windows.zip

      - name: Upload Windows ZIP to Release
        uses: actions/upload-release-asset@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          upload_url: ${{ needs.create-release.outputs.upload_url }}
          asset_path: gotify-client-windows.zip
          asset_name: gotify-client-windows.zip
          asset_content_type: application/zip

  build-macos:
    name: Build macOS
    runs-on: macos-latest
    needs: create-release
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}
          channel: 'stable'

      - name: Get dependencies
        run: flutter pub get

      - name: Run code generation
        run: flutter packages pub run build_runner build --delete-conflicting-outputs

      - name: Build macOS
        run: flutter build macos --release

      - name: Create macOS DMG
        run: |
          chmod +x scripts/create_dmg_simple.sh
          ./scripts/create_dmg_simple.sh

      - name: Create macOS ZIP (fallback)
        run: |
          cd build/macos/Build/Products/Release
          zip -r gotify-client-macos.zip gotify_client_flutter.app

      - name: Upload macOS DMG to Release
        uses: actions/upload-release-asset@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          upload_url: ${{ needs.create-release.outputs.upload_url }}
          asset_path: gotify_client_flutter-*.dmg
          asset_name: gotify-client-macos.dmg
          asset_content_type: application/x-apple-diskimage

      - name: Upload macOS ZIP to Release (fallback)
        uses: actions/upload-release-asset@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          upload_url: ${{ needs.create-release.outputs.upload_url }}
          asset_path: build/macos/Build/Products/Release/gotify-client-macos.zip
          asset_name: gotify-client-macos.zip
          asset_content_type: application/zip

  build-linux:
    name: Build Linux
    runs-on: ubuntu-latest
    needs: create-release
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}
          channel: 'stable'

      - name: Install Linux dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y clang cmake ninja-build pkg-config libgtk-3-dev liblzma-dev libstdc++-12-dev

      - name: Get dependencies
        run: flutter pub get

      - name: Run code generation
        run: flutter packages pub run build_runner build --delete-conflicting-outputs

      - name: Build Linux
        run: flutter build linux --release

      - name: Create Linux TAR
        run: |
          cd build/linux/x64/release/bundle
          tar -czf gotify-client-linux.tar.gz *

      - name: Upload Linux TAR to Release
        uses: actions/upload-release-asset@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          upload_url: ${{ needs.create-release.outputs.upload_url }}
          asset_path: build/linux/x64/release/bundle/gotify-client-linux.tar.gz
          asset_name: gotify-client-linux.tar.gz
          asset_content_type: application/gzip

  build-web:
    name: Build Web
    runs-on: ubuntu-latest
    needs: create-release
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}
          channel: 'stable'

      - name: Get dependencies
        run: flutter pub get

      - name: Run code generation
        run: flutter packages pub run build_runner build --delete-conflicting-outputs

      - name: Build Web
        run: flutter build web --release

      - name: Create Web ZIP
        run: |
          cd build/web
          zip -r gotify-client-web.zip *

      - name: Upload Web ZIP to Release
        uses: actions/upload-release-asset@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          upload_url: ${{ needs.create-release.outputs.upload_url }}
          asset_path: build/web/gotify-client-web.zip
          asset_name: gotify-client-web.zip
          asset_content_type: application/zip